<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Emitir video</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css"></link>
  <link rel="stylesheet" href="/stylesheet/styleEmitir.css"></link>
  <script src="javascripts/jquery-1.11.1.min.js"></script>
  <script src="javascripts/angular.js"></script>
  <script type = "text/javascript" src="/bootstrap/js/bootstrap.min.js"></script>
  <script type = "text/javascript" src="/socket.io/socket.io.js"></script>
</head>
<body ng-app="myApp" ng-controller="myCtrl">
  <div class="row">
    <div class="">
      <video id="video" src="" style="width:680px; height:320px;" autoplay="true"></video>

      <canvas style="display:none;" id="preview"></canvas>
      <div id="chat">
        <div class="external">Mensaje de fuera</div>
        <div class="internal">Mensaje MIO</div>
      </div>
      <div id="logger"></div>


      <script>
      var app = angular.module('myApp', []);
      app.controller('myCtrl', function($scope) {
        var canvas = document.getElementById("preview");
        var context = canvas.getContext("2d");

        canvas.width = 800;
        canvas.height = 600;

        context.width = canvas.width;
        context.height = canvas.height;

        var video = document.getElementById("video");

        var socket = io();

        function logger(msg){
          //document.getElementById('logger').  text(msg);
        }

        function loadCam(stream){
          video.src = window.URL.createObjectURL(stream);
          logger("Camara cargada");
        }

        function failCam() {
          logger("camara no conectada!");
        }

        function viewVideo(video, context) {
          context.drawImage(video,0,0,context.width,context.height);
          socket.emit('stream',canvas.toDataURL('image/webp'));
        }
        var i = 0;

        //$(function() {
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        if(navigator.getUserMedia){
          //que usaremos
          navigator.getUserMedia({video : true},loadCam,failCam);
        }
        setInterval(function(){
          viewVideo(video, context);
          //console.log(i++);
        },1);
        //});
      });
      </script>
    </div>
  </body>
  </html>
